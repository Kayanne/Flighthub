services:
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./api:/var/www/html
      - ./infra/nginx:/etc/nginx/conf.d
    depends_on:
      - php

  php:
    build:
      context: ./infra/php
    volumes:
      - ./api:/var/www/html
      - laravel_storage:/var/www/html/storage
      - laravel_cache:/var/www/html/bootstrap/cache
    depends_on:
      - mysql

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: trip_builder
      MYSQL_USER: trip
      MYSQL_PASSWORD: trip
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - mysql_data:/var/lib/mysql

  frontend:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "127.0.0.1:5173:5173"

    environment:
      - CHOKIDAR_USEPOLLING=true
    command: sh -lc "npm install --no-audit --no-fund && npm run dev -- --host 0.0.0.0 --port 5173 --strictPort"
    depends_on:
      - nginx

volumes:
  mysql_data:
  laravel_storage:
  laravel_cache:
  frontend_node_modules:

